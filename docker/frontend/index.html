<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LiveQuery</title>
    <style>
        :root { --bg: #111; --card: #1a1a1a; --border: #333; --text: #eee; --muted: #888; --accent: #0af; --ok: #0c6; --err: #f44; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font: 12px/1.4 system-ui, sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }
        .app { display: flex; flex-direction: column; height: 100vh; }
        
        header { padding: 6px 10px; background: var(--card); border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; }
        .logo { font-weight: 700; color: var(--accent); }
        .status { padding: 2px 8px; border-radius: 10px; font-size: 10px; }
        .status.on { background: #041; color: #0c6; }
        .status.off { background: #400; color: #f66; }
        .stats { margin-left: auto; font-size: 11px; color: var(--muted); }
        .stats b { color: var(--text); margin-right: 2px; }
        
        nav { display: flex; background: var(--card); border-bottom: 1px solid var(--border); }
        nav button { padding: 8px 12px; font-size: 11px; background: none; border: none; color: var(--muted); cursor: pointer; border-bottom: 2px solid transparent; }
        nav button:hover { color: var(--text); }
        nav button.on { color: var(--accent); border-color: var(--accent); }
        
        main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .panel { display: none; padding: 10px; overflow: auto; }
        .panel.on { display: block; }
        
        input, select, textarea { width: 100%; padding: 6px 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg); color: var(--text); font: inherit; }
        textarea { font-family: monospace; font-size: 11px; min-height: 60px; resize: vertical; }
        label { display: block; font-size: 10px; color: var(--muted); margin-bottom: 4px; }
        .field { margin-bottom: 10px; }
        .row { display: flex; gap: 10px; }
        .row > * { flex: 1; }
        
        button { padding: 6px 12px; border: none; border-radius: 4px; font: inherit; cursor: pointer; }
        .primary { background: var(--accent); color: #000; }
        .success { background: var(--ok); color: #000; }
        .ghost { background: none; border: 1px solid var(--border); color: var(--muted); }
        .ghost:hover { background: var(--border); }
        button:disabled { opacity: .5; }
        
        .data { flex: 1; overflow: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 11px; }
        th, td { padding: 6px 8px; text-align: left; border-bottom: 1px solid var(--border); }
        th { color: var(--muted); font-size: 10px; text-transform: uppercase; position: sticky; top: 0; background: var(--bg); }
        td { font-family: monospace; }
        .empty { color: var(--muted); text-align: center; padding: 40px; }
        
        .log { font-family: monospace; font-size: 11px; }
        .log div { padding: 3px 0; border-bottom: 1px solid #222; }
        .log .t { color: var(--muted); margin-right: 8px; }
        .log .ok { color: var(--ok); }
        .log .err { color: var(--err); }
        
        .subs { display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 10px; }
        .sub { padding: 4px 8px; background: var(--card); border: 1px solid var(--border); border-radius: 4px; font-size: 11px; cursor: pointer; }
        .sub.on { border-color: var(--ok); }
        .sub .x { color: var(--err); margin-left: 6px; }
        
        .actions { display: flex; gap: 6px; margin-top: 10px; flex-wrap: wrap; }
        .actions button { font-size: 11px; padding: 4px 8px; }
    </style>
</head>
<body>
    <div class="app">
        <header>
            <span class="logo">LiveQuery</span>
            <span id="status" class="status off">offline</span>
            <button class="primary" id="connectBtn">Connect</button>
            <div class="stats">
                <b id="nSubs">0</b>subs
                <b id="nRows">0</b>rows
                <b id="latency">-</b>
            </div>
        </header>
        
        <nav>
            <button class="on" data-tab="data">Data</button>
            <button data-tab="subscribe">Subscribe</button>
            <button data-tab="sql">SQL</button>
            <button data-tab="log">Log</button>
        </nav>
        
        <main>
            <div class="panel on" id="dataPanel">
                <div class="subs" id="subs"></div>
                <div class="data" id="data"><div class="empty">No subscriptions</div></div>
            </div>
            
            <div class="panel" id="subscribePanel">
                <div class="row">
                    <div class="field">
                        <label>Preset</label>
                        <select id="preset">
                            <option value="SELECT * FROM orders WHERE status = 'pending'">Orders (pending)</option>
                            <option value="SELECT * FROM orders">Orders (all)</option>
                            <option value="SELECT * FROM products WHERE active = true">Products (active)</option>
                            <option value="SELECT * FROM users">Users</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>Mode</label>
                        <select id="mode">
                            <option value="events">Events</option>
                            <option value="snapshot">Snapshot</option>
                        </select>
                    </div>
                </div>
                <div class="field">
                    <label>Query</label>
                    <textarea id="query">SELECT * FROM orders WHERE status = 'pending'</textarea>
                </div>
                <button class="success" id="subBtn" disabled>Subscribe</button>
            </div>
            
            <div class="panel" id="sqlPanel">
                <div class="field">
                    <label>SQL</label>
                    <textarea id="sql">INSERT INTO orders (user_id, product, amount, status) VALUES (1, 'Test', 99.99, 'pending')</textarea>
                </div>
                <button class="primary" id="execBtn">Execute</button>
                <div id="sqlResult" style="margin-top:8px;font-size:11px;color:var(--muted);"></div>
                <div class="actions">
                    <button class="ghost" data-sql="INSERT INTO orders (user_id, product, amount, status) VALUES (floor(random()*4+1)::int, 'Product', round((random()*500+50)::numeric, 2), 'pending')">+ Order</button>
                    <button class="ghost" data-sql="UPDATE orders SET status = 'shipped' WHERE id = (SELECT id FROM orders WHERE status = 'pending' LIMIT 1)">Ship</button>
                    <button class="ghost" data-sql="DELETE FROM orders WHERE id = (SELECT MAX(id) FROM orders)">Delete</button>
                </div>
            </div>
            
            <div class="panel" id="logPanel">
                <div class="log" id="log"></div>
            </div>
        </main>
    </div>
    
    <input type="hidden" id="natsUrl" value="ws://localhost:9222">

    <script type="module">
        import { connect, StringCodec } from 'https://unpkg.com/nats.ws@1.30.3/esm/nats.js';
        const sc = StringCodec();
        
        let nc = null, subs = new Map(), active = null, cnt = 0;
        const $ = id => document.getElementById(id);
        
        const log = (msg, cls = '') => {
            const t = new Date().toLocaleTimeString('en-GB', {hour12:false});
            $('log').innerHTML = `<div><span class="t">${t}</span><span class="${cls}">${msg}</span></div>` + $('log').innerHTML;
        };
        
        const render = () => {
            $('nSubs').textContent = subs.size;
            $('subs').innerHTML = subs.size ? [...subs].map(([id, s]) => 
                `<span class="sub ${id===active?'on':''}" onclick="sel('${id}')">${s.q.slice(0,25)}… (${s.rows.size})<span class="x" onclick="event.stopPropagation();unsub('${id}')">×</span></span>`
            ).join('') : '';
            
            const s = subs.get(active);
            if (!s || !s.rows.size) { $('data').innerHTML = '<div class="empty">No data</div>'; $('nRows').textContent = 0; return; }
            
            const rows = [...s.rows.values()], cols = Object.keys(rows[0]);
            $('nRows').textContent = rows.length;
            $('data').innerHTML = `<table><thead><tr>${cols.map(c=>`<th>${c}</th>`).join('')}</tr></thead><tbody>${rows.map(r=>`<tr>${cols.map(c=>`<td>${JSON.stringify(r[c])??''}</td>`).join('')}</tr>`).join('')}</tbody></table>`;
        };
        
        window.sel = id => { active = id; render(); };
        window.unsub = async id => {
            if (!nc) return;
            try { await nc.request(`livequery.${id}.unsubscribe`, sc.encode(JSON.stringify({subscription_id:id})), {timeout:5000}); } catch {}
            subs.get(id)?.sub?.unsubscribe();
            subs.delete(id);
            if (active === id) active = subs.keys().next().value || null;
            render();
        };
        
        $('connectBtn').onclick = async () => {
            if (nc) { await nc.close(); nc = null; $('status').className = 'status off'; $('status').textContent = 'offline'; $('connectBtn').textContent = 'Connect'; $('subBtn').disabled = true; return; }
            try {
                nc = await connect({ servers: $('natsUrl').value });
                $('status').className = 'status on'; $('status').textContent = 'online';
                $('connectBtn').textContent = 'Disconnect'; $('subBtn').disabled = false;
                log('Connected', 'ok');
            } catch (e) { log('Failed: ' + e.message, 'err'); }
        };
        
        $('subBtn').onclick = async () => {
            if (!nc) return;
            const q = $('query').value.trim(), mode = $('mode').value;
            if (!q) return;
            
            const id = `w${Date.now()}-${++cnt}`;
            try {
                const res = JSON.parse(sc.decode((await nc.request(`livequery.${id}.subscribe`, sc.encode(JSON.stringify({subscription_id:id, query:q, mode})), {timeout:10000})).data));
                if (!res.success) { log(res.error, 'err'); return; }
                
                const s = { q, mode, rows: new Map(), sub: null };
                (res.snapshot || res.rows || []).forEach(r => { const d = r.data || r; s.rows.set(d.id ?? JSON.stringify(d), d); });
                
                s.sub = nc.subscribe(res.subject);
                (async () => {
                    for await (const m of s.sub) {
                        const b = JSON.parse(sc.decode(m.data));
                        if (b.ts) $('latency').textContent = (Date.now() - b.ts) + 'ms';
                        if (b.events) b.events.forEach(e => e.mz_diff === 1 ? s.rows.set(e.data.id ?? JSON.stringify(e.data), e.data) : s.rows.delete(e.data.id));
                        if (b.rows) { s.rows.clear(); b.rows.forEach(r => s.rows.set(r.id ?? JSON.stringify(r), r)); }
                        if (id === active) render();
                    }
                })();
                
                subs.set(id, s); active = id; render(); switchTab('data');
                log('Subscribed: ' + q.slice(0, 30), 'ok');
            } catch (e) { log(e.message, 'err'); }
        };
        
        const execSql = async sql => {
            $('sqlResult').textContent = '...';
            try {
                const r = await (await fetch('http://localhost:3001/sql', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({sql}) })).json();
                $('sqlResult').textContent = r.error ? 'Error: ' + r.error : 'OK (' + r.rowCount + ')';
                $('sqlResult').style.color = r.error ? 'var(--err)' : 'var(--ok)';
            } catch { $('sqlResult').textContent = 'Error'; $('sqlResult').style.color = 'var(--err)'; }
        };
        
        $('execBtn').onclick = () => execSql($('sql').value);
        document.querySelectorAll('[data-sql]').forEach(b => b.onclick = () => { $('sql').value = b.dataset.sql; execSql(b.dataset.sql); });
        $('preset').onchange = e => $('query').value = e.target.value;
        
        const switchTab = tab => {
            document.querySelectorAll('nav button').forEach(b => b.classList.toggle('on', b.dataset.tab === tab));
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('on'));
            $(tab + 'Panel').classList.add('on');
        };
        document.querySelectorAll('nav button').forEach(b => b.onclick = () => switchTab(b.dataset.tab));
        
        setInterval(() => { if (nc) subs.forEach((_, id) => nc.request(`livequery.${id}.heartbeat`, sc.encode('{}'), {timeout:5000}).catch(() => {})); }, 15000);
        
        setTimeout(() => $('connectBtn').click(), 500);
    </script>
</body>
</html>
